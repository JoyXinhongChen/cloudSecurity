<title>AES Encryption -Decryption</title>
<style>
    * {
        box-sizing: border-box;
    }

    .column {
        float: left;
        width: 30%;
        padding: 10px;

    }

    /* Clear floats after the columns */
    .row:after {
        content: "";
        display: table;
        clear: both;
    }

    span {
        padding-right: 50px;
    }
</style>
<script type="text/javascript" src=sjcl.js></script>
</head>

<body>

    <h1>AES Encryption -Decryption</h1>
    <p>
        <div class="row">
            <div class="column">
                <label>32 hexadeciaml digits key(128 bits):</label>
            </div>
            <div class="column">
                <textarea id="input1" rows="2" cols="80"></textarea>
            </div>

        </div>

        <div class="row">
            <div class="column">
                <label>Choose a file:</label>
            </div>
            <div class="column">
                <input type="file" id="file" name="file" multiple />
                <output id="list"></output>
            </div>

        </div>

        <div class="row">
            <div class="column">
                <label>File contents:</label>
            </div>
            <div class="column">
                <textarea id="content" rows="10" cols="80"></textarea>
            </div>

        </div>

        <div class="row">
            <div class="column">
                <label>Message for authentication:</label>
            </div>
            <div class="column">
                <textarea id="message" rows="2" cols="80"></textarea>
                <button id="enc">Encryption</button><button id="dec">Decryption</button>
            </div>

        </div>
        <div class="row">
            <div class="column">
                <label>Encrypted file:</label>
            </div>
            <div class="column">
                <textarea id="encContent" rows="10" cols="80"></textarea>
            </div>

        </div>

        <div class="row">
            <div class="column">
                <label>HMAC:</label>
            </div>
            <div class="column">
                <textarea id="hmac" rows="2" cols="80"></textarea>
            </div>

        </div>

        <div class="row">
            <div class="column">
                <label>Save file:</label>
            </div>
            <div class="column">
                <input id="encFileName1"></input>
                <br>
                <button id="save1">Save to file</button>
            </div>

        </div>

        <div class="row">
            <div class="column">
                <label>Save file with encrypted info:</label>
            </div>
            <div class="column">
                <input id="encFileName2"></input>
                <br>
                <button id="save2">Save to file</button>
            </div>

        </div>

        <script type="text/javascript">
        var encContent;
        var key;

            document.getElementById('file').onchange = function () {

                var file = this.files[0];

                var reader = new FileReader();
                reader.onload = function (progressEvent) {
                    // Entire file
                    var content = document.getElementById('content');
                    content.value = this.result;
                     

                    //display file type, size,name, modified date
                    var output = [];
                    output.push('<li><strong>', escape(file.name), '</strong> (', file.type || 'n/a', ') - ',
                        file.size, ' bytes, last modified: ',
                        file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() : 'n/a',
                        '</li>');
                    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';

                    // By lines
                    var lines = this.result.split('\n');
                    for (var line = 0; line < lines.length; line++) {
                        console.log(lines[line]);
                    }
                };
                reader.readAsText(file);
            };

            document.getElementById("enc").onclick = function () {
                var input1 = document.getElementById("input1").value;
                key = new Array(input1.split(" ")[0], input1.split(" ")[1], input1.split(" ")[2], input1.split(" ")[3]);
                var content = document.getElementById("content").value;
                var message = document.getElementById("message").value;
                //encryption
                var p = {adata:message, iter:1000,mode:'ccm',ts:64,ks:128}
                encContent = sjcl.encrypt(key, content, p);
                var jsObject = eval("(" + encContent + ")");
                var ciphertext = jsObject.ct;
                document.getElementById("encContent").value = ciphertext;
                var hmac = JSON.parse(encContent).adata;
                document.getElementById("hmac").value = hmac;
                document.getElementById("content").value = "";
            }

            document.getElementById("dec").onclick = function () {
                var content = document.getElementById("content").value;
                //decryption
                var plaintext = sjcl.decrypt(key, encContent);
                console.log(plaintext);
                document.getElementById("content").value = plaintext;
                document.getElementById("encContent").value = "";
            }

            document.getElementById("save1").onclick = function () {
                var fileName = document.getElementById("encFileName1").value;
                var encContent = document.getElementById("encContent").value;
                download(fileName,encContent);
            }

            document.getElementById("save2").onclick = function () {
                var fileName = document.getElementById("encFileName2").value;
                var encContent = document.getElementById("encContent").value;
                var hmac = document.getElementById("hmac").value;
                download(fileName,encContent+"\n"+hmac);
            }

            function download(filename, text) {
                var pom = document.createElement('a');
                pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                pom.setAttribute('download', filename);

                if (document.createEvent) {
                    var event = document.createEvent('MouseEvents');
                    event.initEvent('click', true, true);
                    pom.dispatchEvent(event);
                }
                else {
                    pom.click();
                }
            }



        </script>
    </p>

</body>